import time
import pandas as pd
from bs4 import BeautifulSoup
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

# Login-Daten f√ºr Drittanbieter (Zugfinder) 
USERNAME = "*******"
PASSWORD = "*******"
ice_zuege = [
  "ICE_3",
  "ICE_4",
  "ICE_5",
  "ICE_10",
  "ICE_11",
  "ICE_12",
  "ICE_13",
  "ICE_14",
  "ICE_15",
  "ICE_16",
  "ICE_17",
  "ICE_18",
  "ICE_19",
  "ICE_20",
  "ICE_21",
  "ICE_22",
  "ICE_23",
  "ICE_26",
  "ICE_27",
  "ICE_28",
  "ICE_29",
  "ICE_70",
  "ICE_71",
  "ICE_72",
  "ICE_73",
  "ICE_74",
  "ICE_75",
  "ICE_76",
  "ICE_77",
  "ICE_78",
  "ICE_79",
  "ICE_90",
  "ICE_91",
  "ICE_92",
  "ICE_93",
  "ICE_94",
  "ICE_95",
  "ICE_100",
  "ICE_101",
  "ICE_102",
  "ICE_103",
  "ICE_104",
  "ICE_105",
  "ICE_106",
  "ICE_107",
  "ICE_108",
  "ICE_109",
  "ICE_114",
  "ICE_115",
  "ICE_117",
  "ICE_118",
  "ICE_119",
  "ICE_120",
  "ICE_121",
  "ICE_122",
  "ICE_123",
  "ICE_124",
  "ICE_125",
  "ICE_126",
  "ICE_127",
  "ICE_128",
  "ICE_129",
  "ICE_152",
  "ICE_153",
  "ICE_154",
  "ICE_155",
  "ICE_156",
  "ICE_157",
  "ICE_158",
  "ICE_159",
  "ICE_200",
  "ICE_201",
  "ICE_202",
  "ICE_203",
  "ICE_205",
  "ICE_206",
  "ICE_207",
  "ICE_208",
  "ICE_209",
  "ICE_220",
  "ICE_221",
  "ICE_222",
  "ICE_224",
  "ICE_225",
  "ICE_228",
  "ICE_229",
  "ICE_250",
  "ICE_251",
  "ICE_252",
  "ICE_253",
  "ICE_254",
  "ICE_255",
  "ICE_266",
  "ICE_267",
  "ICE_270",
  "ICE_271",
  "ICE_272",
  "ICE_273",
  "ICE_274",
  "ICE_275",
  "ICE_276",
  "ICE_277",
  "ICE_278",
  "ICE_279",
  "ICE_292",
  "ICE_314",
  "ICE_315",
  "ICE_316",
  "ICE_317",
  "ICE_318",
  "ICE_319",
  "ICE_370",
  "ICE_371",
  "ICE_372",
  "ICE_373",
  "ICE_374",
  "ICE_375",
  "ICE_376",
  "ICE_377",
  "ICE_474",
  "ICE_500",
  "ICE_501",
  "ICE_502",
  "ICE_503",
  "ICE_504",
  "ICE_505",
  "ICE_506",
  "ICE_507",
  "ICE_508",
  "ICE_509",
  "ICE_510",
  "ICE_511",
  "ICE_512",
  "ICE_513",
  "ICE_514",
  "ICE_515",
  "ICE_516",
  "ICE_517",
  "ICE_518",
  "ICE_519",
  "ICE_520",
  "ICE_521",
  "ICE_522",
  "ICE_523",
  "ICE_524",
  "ICE_525",
  "ICE_526",
  "ICE_527",
  "ICE_528",
  "ICE_529",
  "ICE_532",
  "ICE_533",
  "ICE_535",
  "ICE_536",
  "ICE_537",
  "ICE_538",
  "ICE_540",
  "ICE_541",
  "ICE_542",
  "ICE_543",
  "ICE_544",
  "ICE_545",
  "ICE_546",
  "ICE_547",
  "ICE_548",
  "ICE_549",
  "ICE_552",
  "ICE_553",
  "ICE_554",
  "ICE_555",
  "ICE_556",
  "ICE_557",
  "ICE_558",
  "ICE_559",
  "ICE_560",
  "ICE_561",
  "ICE_562",
  "ICE_563",
  "ICE_564",
  "ICE_565",
  "ICE_566",
  "ICE_567",
  "ICE_568",
  "ICE_569",
  "ICE_570",
  "ICE_571",
  "ICE_572",
  "ICE_573",
  "ICE_575",
  "ICE_576",
  "ICE_577",
  "ICE_578",
  "ICE_579",
  "ICE_580",
  "ICE_581",
  "ICE_582",
  "ICE_583",
  "ICE_584",
  "ICE_585",
  "ICE_586",
  "ICE_587",
  "ICE_588",
  "ICE_590",
  "ICE_591",
  "ICE_592",
  "ICE_593",
  "ICE_594",
  "ICE_595",
  "ICE_596",
  "ICE_597",
  "ICE_600",
  "ICE_601",
  "ICE_602",
  "ICE_603",
  "ICE_608",
  "ICE_609",
  "ICE_610",
  "ICE_611",
  "ICE_612",
  "ICE_613",
  "ICE_614",
  "ICE_615",
  "ICE_616",
  "ICE_617",
  "ICE_618",
  "ICE_619",
  "ICE_620",
  "ICE_621",
  "ICE_622",
  "ICE_623",
  "ICE_624",
  "ICE_625",
  "ICE_626",
  "ICE_627",
  "ICE_628",
  "ICE_629",
  "ICE_630",
  "ICE_631",
  "ICE_633",
  "ICE_634",
  "ICE_635",
  "ICE_636",
  "ICE_640",
  "ICE_641",
  "ICE_642",
  "ICE_643",
  "ICE_644",
  "ICE_645",
  "ICE_646",
  "ICE_649",
  "ICE_650",
  "ICE_651",
  "ICE_652",
  "ICE_653",
  "ICE_654",
  "ICE_655",
  "ICE_656",
  "ICE_657",
  "ICE_672",
  "ICE_674",
  "ICE_680",
  "ICE_681",
  "ICE_682",
  "ICE_683",
  "ICE_684",
  "ICE_685",
  "ICE_689",
  "ICE_690",
  "ICE_691",
  "ICE_692",
  "ICE_693",
  "ICE_694",
  "ICE_695",
  "ICE_696",
  "ICE_697",
  "ICE_698",
  "ICE_699",
  "ICE_700",
  "ICE_701",
  "ICE_702",
  "ICE_703",
  "ICE_704",
  "ICE_705",
  "ICE_706",
  "ICE_707",
  "ICE_708",
  "ICE_709",
  "ICE_710",
  "ICE_711",
  "ICE_713",
  "ICE_714",
  "ICE_715",
  "ICE_720",
  "ICE_721",
  "ICE_722",
  "ICE_723",
  "ICE_724",
  "ICE_725",
  "ICE_726",
  "ICE_727",
  "ICE_728",
  "ICE_729",
  "ICE_731",
  "ICE_735",
  "ICE_740",
  "ICE_741",
  "ICE_742",
  "ICE_750",
  "ICE_751",
  "ICE_752",
  "ICE_753",
  "ICE_756",
  "ICE_757",
  "ICE_758",
  "ICE_759",
  "ICE_770",
  "ICE_771",
  "ICE_772",
  "ICE_773",
  "ICE_774",
  "ICE_775",
  "ICE_776",
  "ICE_780",
  "ICE_781",
  "ICE_782",
  "ICE_783",
  "ICE_786",
  "ICE_787",
  "ICE_788",
  "ICE_789",
  "ICE_790",
  "ICE_791",
  "ICE_792",
  "ICE_793",
  "ICE_794",
  "ICE_795",
  "ICE_796",
  "ICE_797",
  "ICE_798",
  "ICE_799",
  "ICE_800",
  "ICE_801",
  "ICE_802",
  "ICE_803",
  "ICE_804",
  "ICE_805",
  "ICE_806",
  "ICE_808",
  "ICE_810",
  "ICE_811",
  "ICE_812",
  "ICE_813",
  "ICE_814",
  "ICE_815",
  "ICE_816",
  "ICE_817",
  "ICE_818",
  "ICE_819",
  "ICE_820",
  "ICE_821",
  "ICE_822",
  "ICE_823",
  "ICE_824",
  "ICE_825",
  "ICE_826",
  "ICE_827",
  "ICE_832",
  "ICE_833",
  "ICE_834",
  "ICE_835",
  "ICE_836",
  "ICE_837",
  "ICE_838",
  "ICE_839",
  "ICE_840",
  "ICE_841",
  "ICE_842",
  "ICE_843",
  "ICE_844",
  "ICE_845",
  "ICE_846",
  "ICE_847",
  "ICE_848",
  "ICE_849",
  "ICE_853",
  "ICE_854",
  "ICE_855",
  "ICE_856",
  "ICE_857",
  "ICE_858",
  "ICE_859",
  "ICE_870",
  "ICE_871",
  "ICE_872",
  "ICE_876",
  "ICE_877",
  "ICE_879",
  "ICE_880",
  "ICE_881",
  "ICE_882",
  "ICE_883",
  "ICE_885",
  "ICE_886",
  "ICE_887",
  "ICE_888",
  "ICE_892",
  "ICE_900",
  "ICE_901",
  "ICE_902",
  "ICE_903",
  "ICE_904",
  "ICE_905",
  "ICE_907",
  "ICE_908",
  "ICE_909",
  "ICE_910",
  "ICE_911",
  "ICE_912",
  "ICE_913",
  "ICE_914",
  "ICE_915",
  "ICE_916",
  "ICE_918",
  "ICE_919",
  "ICE_920",
  "ICE_921",
  "ICE_922",
  "ICE_927",
  "ICE_928",
  "ICE_929",
  "ICE_930",
  "ICE_931",
  "ICE_932",
  "ICE_933",
  "ICE_934",
  "ICE_935",
  "ICE_937",
  "ICE_938",
  "ICE_940",
  "ICE_941",
  "ICE_942",
  "ICE_943",
  "ICE_944",
  "ICE_945",
  "ICE_946",
  "ICE_947",
  "ICE_950",
  "ICE_951",
  "ICE_952",
  "ICE_953",
  "ICE_954",
  "ICE_955",
  "ICE_956",
  "ICE_957",
  "ICE_984",
  "ICE_985",
  "ICE_987",
  "ICE_990",
  "ICE_991",
  "ICE_992",
  "ICE_994",
  "ICE_995",
  "ICE_996",
  "ICE_997",
  "ICE_998",
  "ICE_999",
  "ICE_1000",
  "ICE_1001",
  "ICE_1002",
  "ICE_1003",
  "ICE_1004",
  "ICE_1005",
  "ICE_1006",
  "ICE_1007",
  "ICE_1008",
  "ICE_1009",
  "ICE_1010",
  "ICE_1011",
  "ICE_1012",
  "ICE_1013",
  "ICE_1014",
  "ICE_1015",
  "ICE_1018",
  "ICE_1019",
  "ICE_1020",
  "ICE_1021",
  "ICE_1022",
  "ICE_1028",
  "ICE_1030",
  "ICE_1031",
  "ICE_1034",
  "ICE_1035",
  "ICE_1038",
  "ICE_1050",
  "ICE_1051",
  "ICE_1052",
  "ICE_1053",
  "ICE_1059",
  "ICE_1060",
  "ICE_1061",
  "ICE_1063",
  "ICE_1064",
  "ICE_1065",
  "ICE_1066",
  "ICE_1067",
  "ICE_1068",
  "ICE_1069",
  "ICE_1070",
  "ICE_1072",
  "ICE_1073",
  "ICE_1074",
  "ICE_1075",
  "ICE_1076",
  "ICE_1077",
  "ICE_1078",
  "ICE_1079",
  "ICE_1080",
  "ICE_1081",
  "ICE_1083",
  "ICE_1084",
  "ICE_1085",
  "ICE_1087",
  "ICE_1088",
  "ICE_1091",
  "ICE_1094",
  "ICE_1095",
  "ICE_1097",
  "ICE_1098",
  "ICE_1099",
  "ICE_1100",
  "ICE_1102",
  "ICE_1103",
  "ICE_1104",
  "ICE_1105",
  "ICE_1106",
  "ICE_1107",
  "ICE_1108",
  "ICE_1109",
  "ICE_1110",
  "ICE_1111",
  "ICE_1112",
  "ICE_1113",
  "ICE_1114",
  "ICE_1115",
  "ICE_1118",
  "ICE_1120",
  "ICE_1121",
  "ICE_1122",
  "ICE_1123",
  "ICE_1128",
  "ICE_1131",
  "ICE_1132",
  "ICE_1133",
  "ICE_1136",
  "ICE_1139",
  "ICE_1154",
  "ICE_1155",
  "ICE_1156",
  "ICE_1157",
  "ICE_1158",
  "ICE_1159",
  "ICE_1168",
  "ICE_1171",
  "ICE_1178",
  "ICE_1179",
  "ICE_1200",
  "ICE_1201",
  "ICE_1202",
  "ICE_1203",
  "ICE_1204",
  "ICE_1205",
  "ICE_1206",
  "ICE_1207",
  "ICE_1212",
  "ICE_1218",
  "ICE_1219",
  "ICE_1222",
  "ICE_1223",
  "ICE_1224",
  "ICE_1252",
  "ICE_1276",
  "ICE_1279",
  "ICE_1282",
  "ICE_1283",
  "ICE_1284",
  "ICE_1285",
  "ICE_1290",
  "ICE_1500",
  "ICE_1511",
  "ICE_1512",
  "ICE_1513",
  "ICE_1544",
  "ICE_1545",
  "ICE_1546",
  "ICE_1550",
  "ICE_1552",
  "ICE_1553",
  "ICE_1554",
  "ICE_1555",
  "ICE_1556",
  "ICE_1557",
  "ICE_1558",
  "ICE_1559",
  "ICE_1572",
  "ICE_1573",
  "ICE_1574",
  "ICE_1575",
  "ICE_1576",
  "ICE_1577",
  "ICE_1578",
  "ICE_1579",
  "ICE_1581",
  "ICE_1586",
  "ICE_1594",
  "ICE_1597",
  "ICE_1599",
  "ICE_1600",
  "ICE_1601",
  "ICE_1604",
  "ICE_1605",
  "ICE_1606",
  "ICE_1607",
  "ICE_1611",
  "ICE_1621",
  "ICE_1636",
  "ICE_1650",
  "ICE_1651",
  "ICE_1652",
  "ICE_1653",
  "ICE_1654",
  "ICE_1655",
  "ICE_1656",
  "ICE_1657",
  "ICE_1658",
  "ICE_1659",
  "ICE_1671",
  "ICE_1672",
  "ICE_1674",
  "ICE_1675",
  "ICE_1676",
  "ICE_1677",
  "ICE_1678",
  "ICE_1679",
  "ICE_1683",
  "ICE_1687",
  "ICE_1694",
  "ICE_1695",
  "ICE_1701",
  "ICE_1704",
  "ICE_1705",
  "ICE_1710",
  "ICE_1711",
  "ICE_1714",
  "ICE_1715",
  "ICE_1717",
  "ICE_1941",
  "ICE_1942",
  "ICE_1944",
  "ICE_1945",
  "ICE_1954",
  "ICE_1955",
  "ICE_2325",
  "ICE_2500",
  "ICE_2501",
  "ICE_2502",
  "ICE_2503",
  "ICE_2504",
  "ICE_2505",
  "ICE_2506",
  "ICE_2507",
  "ICE_2508",
  "ICE_2509",
  "ICE_2510",
  "ICE_2511",
  "ICE_2512",
  "ICE_2513",
  "ICE_2514",
  "ICE_2515",
  "ICE_2516",
  "ICE_2517",
  "ICE_2518",
  "ICE_2519",
  "ICE_2520",
  "ICE_2521",
  "ICE_2522",
  "ICE_2523",
  "ICE_2524",
  "ICE_2525",
  "ICE_2526",
  "ICE_2527",
  "ICE_2529",
  "ICE_2530",
  "ICE_2531",
  "ICE_2532",
  "ICE_2533",
  "ICE_2534",
  "ICE_2535",
  "ICE_2536",
  "ICE_2537",
  "ICE_2538",
  "ICE_2539",
  "ICE_2540",
  "ICE_2542",
  "ICE_2544",
  "ICE_2547",
  "ICE_2548",
  "ICE_2555",
  "ICE_2556",
  "ICE_2559",
  "ICE_2561",
  "ICE_2806",
  "ICE_2807",
  "ICE_2809",
  "ICE_2811",
  "ICE_2817",
  "ICE_2819",
  "ICE_2821",
  "ICE_2824",
  "ICE_2825",
  "ICE_2827",
  "ICE_2829",
  "ICE_2831",
  "ICE_2836",
  "ICE_2840",
  "ICE_2841",
  "ICE_2842",
  "ICE_2843",
  "ICE_2844",
  "ICE_2845",
  "ICE_2846",
  "ICE_2847",
  "ICE_2848",
  "ICE_2849",
  "ICE_2851",
  "ICE_2852",
  "ICE_2853",
  "ICE_2856",
  "ICE_2859",
  "ICE_2860",
  "ICE_2861",
  "ICE_2862",
  "ICE_2863",
  "ICE_2864",
  "ICE_2866",
  "ICE_2868",
  "ICE_2870",
  "ICE_2871",
  "ICE_2873",
  "ICE_2874",
  "ICE_2875",
  "ICE_2876",
  "ICE_2877",
  "ICE_2878",
  "ICE_2879",
  "ICE_2881",
  "ICE_2885",
  "ICE_2886",
  "ICE_2888",
  "ICE_2889",
  "ICE_2890",
  "ICE_2891",
  "ICE_2894",
  "ICE_2896",
  "ICE_2900",
  "ICE_2901",
  "ICE_2902",
  "ICE_2903",
  "ICE_2904",
  "ICE_2905",
  "ICE_2906",
  "ICE_2907",
  "ICE_2908",
  "ICE_2909",
  "ICE_2910",
  "ICE_2911",
  "ICE_2912",
  "ICE_2913",
  "ICE_2914",
  "ICE_2915",
  "ICE_2916",
  "ICE_2917",
  "ICE_2918",
  "ICE_2919",
  "ICE_2920",
  "ICE_2921",
  "ICE_2922",
  "ICE_2923",
  "ICE_2924",
  "ICE_2925",
  "ICE_2926",
  "ICE_2927",
  "ICE_2928",
  "ICE_2929",
  "ICE_2930",
  "ICE_2931",
  "ICE_2932",
  "ICE_2933",
  "ICE_2934",
  "ICE_2935",
  "ICE_2936",
  "ICE_2937",
  "ICE_2938",
  "ICE_2939",
  "ICE_2940",
  "ICE_2941",
  "ICE_2942",
  "ICE_2943",
  "ICE_2944",
  "ICE_2945",
  "ICE_2946",
  "ICE_2947",
  "ICE_2948",
  "ICE_2949",
  "ICE_2950",
  "ICE_2951",
  "ICE_2952",
  "ICE_2953",
  "ICE_2954",
  "ICE_2955",
  "ICE_2956",
  "ICE_2957",
  "ICE_9496",
  "ICE_9514",
  "ICE_9544",
  "ICE_9545",
  "ICE_9550",
  "ICE_9553",
  "ICE_9554",
  "ICE_9555",
  "ICE_9556",
  "ICE_9557",
  "ICE_9558",
  "ICE_9563",
  "ICE_9566",
  "ICE_9568",
  "ICE_9571",
  "ICE_9572",
  "ICE_9573",
  "ICE_9574",
  "ICE_9586",
  "ICE_9590",
  "ICE_9591",
  "ICE_20186",
  "ICE_26324",
  "ICE_26325",
  "ICE_69068",
  "ICE_69072",
  "ICE_69073",
  "ICE_70079",
  "ICE_90021",
  "ICE_92891"
]
# Hier k√∂nnen die ben√∂tigten ICEs hinzugef√ºgt werden - es ist jedoch ratsam offizielle Daten der DB einzuholen

# Browser Setup 
options = Options()
options.add_argument("--headless")
options.add_argument("--window-size=1400x1000")
driver = webdriver.Chrome(options=options)
wait = WebDriverWait(driver, 10)

# Ergebnisliste
all_data = []

try:
    # 1. Login
    driver.get("https://www.zugfinder.net/de/login")
    wait.until(EC.presence_of_element_located((By.NAME, "email"))).send_keys(USERNAME)
    driver.find_element(By.NAME, "pass").send_keys(PASSWORD)
    driver.find_element(By.XPATH, "//input[@type='submit']").click()
    time.sleep(2)
    print("Eingeloggt")

    # 2. Pro ICE-Zug verarbeiten
    for zug in ice_zuege:
        print(f"\n Verarbeite {zug}")
        driver.get(f"https://www.zugfinder.net/de/zug-{zug}")
        time.sleep(2)

        try:
            # Link zur externen Fahrplanseite holen
            fahrplan_link = driver.find_element(By.XPATH, "//a[contains(text(),'Fahrplan')]").get_attribute("href")
            print(f"Lade Fahrplan: {fahrplan_link}")
            driver.get(fahrplan_link)
            time.sleep(3)

            # 3. Parser f√ºr die geplanten Zeiten
            soup = BeautifulSoup(driver.page_source, "html.parser")
            rows = soup.find_all("tr", bgcolor=["#E7EEF9", "#99BAE4"])

            def get_planned_time(cell):
                for span in cell.find_all("span"):
                    span.extract()  # Entfernt Versp√§tung / Prognose
                return cell.get_text(strip=True)

            for row in rows:
                tds = row.find_all("td")
                if len(tds) >= 10:
                    halt = tds[1].get_text(strip=True)
                    ankunft = get_planned_time(tds[3])
                    abfahrt = get_planned_time(tds[5])
                    gleis = get_planned_time(tds[9])

                    all_data.append({
                        "zug": zug,
                        "halt": halt,
                        "ankunft_geplant": ankunft,
                        "abfahrt_geplant": abfahrt,
                        "gleis": gleis
                    })

        except Exception as e:
            print(f"Fehler bei {zug}: {e}")

finally:
    driver.quit()
    print("Browser geschlossen")

# 4. CSV speichern
if all_data:
    df = pd.DataFrame(all_data)
    df.to_csv("alle_ice_fahrplaene_final.csv", index=False, encoding="utf-8-sig")
    print("Datei gespeichert: alle_ice_fahrplaene_final.csv")
else:
    print("Keine Fahrplandaten")

